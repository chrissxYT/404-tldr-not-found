#!/usr/bin/env python3
# TODO: use tldrl
# TODO: support for other edits (`rawedit`: opens `SHELL` in pages/common)
# TODO: alias for making aliases really quickly
# TODO: pull request
from argparse import ArgumentParser
from os import path, chdir
from subprocess import run, PIPE
from tldrlib import *
from urllib.parse import urlencode

def sh(cmd, **kwargs):
    return run(cmd, shell=True, check=True, **kwargs)

def run_open(arg, **kwargs):
    """unfortunately this doesnt work on linux, we might want to use xdg-open there"""
    return run(['open', arg], check=True, **kwargs)

def checkout(branch):
    """checks out main, then checks out `branch`, using -b if it doesn't exist"""
    sh('git checkout main && git pull')
    flag = '-b' if branch not in sh('git branch', stdout=PIPE).stdout.decode('utf-8') else ''
    sh(f'git checkout {flag} {branch}')

home = getenv('HOME')

with open(f'{home}/.config/tldrgal/username') as f:
    username = f.readline().strip()

parser = ArgumentParser()
parser.add_argument('action', help='what you want to do, possible values: missing, add/new, edit, request')
parser.add_argument('-l', '--lang', help='the language of the tldr page(s) in question')
parser.add_argument('-p', '--platform', help='the platform of the tldr page(s) in question')
parser.add_argument('-n', '--name', help='the name of the tldr page(s) in question')
#parser.add_argument('-m', '--commit-message')
args = parser.parse_args()

if 'tldrl' not in get_all_installed_programs():
    sh('npm install -g tldr-lint')

if args.action == 'missing':
    l = list(get_all_installed_programs() - get_all_tldr_pages())
    l.sort()
    for p in l:
        if not '.' in p:
            print(p)
elif args.action == 'add' or args.action == 'new':
    if args.name is None:
        print('-n/--name is required for the add action')
        exit(1)
    if args.platform is None:
        args.platform = 'common'
    folder = home + '/.tldrgal-temp-tldr'
    if not path.exists(folder):
        input('Please make sure, you have created your fork, before saving. (Enter to acknowledge)')
        sh(f'git clone {TLDR_REPO} {folder}')
        sh(f'cd {folder} && git remote set-url origin https://github.com/{username}/tldr.git')
    if not path.isdir(folder):
        print(f'{folder} exists but is not a directory, that is REALLY weird, please...delete it?')
        exit(1)
    chdir(folder)
    dest = 'pages'
    if args.lang is not None:
        dest += '.' + args.lang
    dest += f'/{args.platform}/{args.name}.md'
    checkout(args.name)
    f = open(dest, 'w')
    f.write(f'# {args.name}\n\n'
            '> DESC\n'
            '> More information: <insert>.\n\n'
            '- Example1:\n\n'
            '`' + args.name + ' {{arg1}} {{arg2}}`')
    f.close()
    editor = getenv('EDITOR', 'vi')
    sh(f'{editor} {dest}')
    sh(f'git add -A && git commit -m "{args.name}: add page"')
    sh(f'git push -u origin {args.name}')
elif args.action == 'edit':
    if args.name is None:
        print('-n/--name is required for the edit action')
        exit(1)
    if args.platform is None:
        args.platform = 'common'
    folder = home + '/.tldrgal-temp-tldr'
    if not path.exists(folder):
        input('Please make sure, you have created your fork, before saving. (Enter to acknowledge)')
        sh(f'git clone {TLDR_REPO} {folder}')
        sh(f'cd {folder} && git remote set-url origin https://github.com/{username}/tldr.git')
    if not path.isdir(folder):
        print(f'{folder} exists but is not a directory, that is REALLY weird, please...delete it?')
        exit(1)
    chdir(folder)
    dest = 'pages'
    if args.lang is not None:
        dest += '.' + args.lang
    dest += f'/{args.platform}/{args.name}.md'
    checkout(args.name)
    editor = getenv('EDITOR', 'vi')
    sh(f'{editor} {dest}')
    sh(f'git add -A && GIT_EDITOR={editor} git commit -e -m "{args.name}: "')
    sh(f'git push -u origin {args.name}')
elif args.action == 'request':
    if args.name is None:
        print('-n/--name is required for the request action')
        exit(1)
    run_open('https://github.com/tldr-pages/tldr/issues/new?' + urlencode({'title': 'page request: ' + args.name}))
else:
    print('Unknown action.')
    exit(1)
